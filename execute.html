<h1 id="execute">Execute Proposal</h1>
<div id="display"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.6.4/ethers.umd.min.js" integrity="sha512-EKCEAWajhazrbxxXV+UKphn1Vl1MhIbZxCy5kPVzVrTRKYJ96r7QtPgnK+Zvoi2Er1S3jU/y+ZgCGMA+A7Hdug==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="./scripts/getProvider.js"></script>
<script src="./scripts/config.js"></script>
<script src="./scripts/fetchSubgraph.js"></script>
<script>
  window.addEventListener("load", async (event) => {
    // fetch from ./scripts/fetchSubgraph.js
    const subgraph = await fetchSubgraph();
    // get state of each proposal
    const provider = await getProvider();
    const Contract = new ethers.Contract(config.commonsAddress, config.commonsAbi, provider);
    // filter out proposals that are active and can be executed
    const executableProposals = [];
    for (let i = 0; i < subgraph.length; i++) {
      const proposalState = await Contract["state"](subgraph[i].proposalId);
      // state 4 means that the proposal is active and can be executed
      if (proposalState == 4) {
        executableProposals.push(subgraph[i]);
      }
    }
    // display proposals
    const display = executableProposals.map((val) => {
      return `<div>
        <button onClick="execute('${val.calls[0].calldata}', '${val.description}')">${val.description}</button>
        </div>`;
    });
    document.getElementById("display").innerHTML = display;
  });

  async function execute(_callData, _description) {
    const provider = await getProvider();
    const Contract = new ethers.Contract(config.commonsAddress, config.commonsAbi, provider);
    const descriptionHash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(_description));
    const { data } = await Contract.populateTransaction["execute"]([config.fishAddress], [0], [_callData], descriptionHash);
    const signer = provider.getSigner();
    const receipt = await signer
      .sendTransaction({
        to: config.commonsAddress,
        data,
      })
      .catch((err) => {
        console.error(err);
        return err.message;
      });
    // display tx hash
    console.log(receipt)
    const txHash = receipt.hash || "";
    document.getElementById("execute").innerHTML = "Execute Proposal " + txHash;
  }
</script>
